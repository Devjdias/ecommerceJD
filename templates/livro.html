<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/livro.css') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/iconLivro.png') }}" />
    <title>{{ livro['titulo'] }} - ClicLeitura</title>
</head>

<body>
    <div class="livro-detalhes">
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .livro-detalhes img {
            max-width: 300px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .checkout-form {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .checkout-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkout-form button {
            padding: 12px 30px;
            background: #702727;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .checkout-form button:hover {
            background: #501919;
        }
        .qr-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .qr-container img {
            max-width: 300px;
        }
        .btn-voltar {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #ddd;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="livro-detalhes">
        <a href="{{ url_for('index') }}" class="btn-voltar">‚Üê Voltar para a loja</a>
        
        {% if livro['imagem'].startswith('http') %}
            <img src="{{ livro['imagem'] }}" alt="{{ livro['titulo'] }}" style="max-width: 300px;" />
        {% else %}
            <img src="{{ url_for('static', filename='images/' + livro['imagem']) }}" alt="{{ livro['titulo'] }}" />
        {% endif %}
        
        <h1>{{ livro['titulo'] }}</h1>
        <p><strong>Autor:</strong> {{ livro['autor'] }}</p>
        <p><strong>Fonte:</strong> {{ livro['origem'] }}</p>
        
        {% if livro['descricao'] %}
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-left: 4px solid #702727; border-radius: 4px;">
            <h3 style="margin-top: 0; color: #702727;">üìñ Sobre este E-book</h3>
            <p style="line-height: 1.6; text-align: justify; color: #333;">{{ livro['descricao'] }}</p>
        </div>
        {% endif %}
        
        <h2 style="color: #702727;">R$ {{ "%.2f"|format(livro['preco']) }}</h2>
        
        <button onclick="adicionarAoCarrinho()" style="padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-bottom: 20px;">
            üõí Adicionar ao Carrinho
        </button>
        
        <div class="checkout-form">
            <h3>Comprar E-book</h3>
            <p>Ap√≥s o pagamento, o e-book ser√° enviado automaticamente para seu e-mail!</p>
            
            <form id="checkoutForm">
                <input type="email" id="emailInput" placeholder="Seu e-mail" required />
                <button type="submit">Gerar PIX e Comprar</button>
            </form>
            
            <div class="qr-container" id="qrContainer">
                <h3>Escaneie o QR Code PIX</h3>
                <img id="qrImage" src="" alt="QR Code PIX" />
                <p id="pixText"></p>
                <button onclick="simularPagamento()">Simular Pagamento Realizado</button>
            </div>
        </div>
    </div>

    <script>
        let pedidoAtual = null;
        let usuarioLogado = null;

        // Verificar se usu√°rio est√° logado ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            usuarioLogado = usuario;
            const emailInput = document.getElementById('emailInput');
            
            if (usuario) {
                // Se logado, preencher email automaticamente e desabilitar campo
                emailInput.value = usuario.email;
                emailInput.readOnly = true;
                emailInput.style.background = '#f0f0f0';
            }
        });

        async function adicionarAoCarrinho() {
            if (!usuarioLogado) {
                alert('‚ö†Ô∏è Voc√™ precisa fazer login para adicionar ao carrinho!');
                sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
                window.location.href = '/login';
                return;
            }

            const livroId = {{ livro['id'] }};

            try {
                const response = await fetch('/api/carrinho/adicionar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        usuario_id: usuarioLogado.id,
                        livro_id: livroId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (confirm('‚úÖ Livro adicionado ao carrinho! Deseja ir para o carrinho?')) {
                        window.location.href = '/';
                    }
                } else {
                    alert(data.error || 'Erro ao adicionar ao carrinho');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Verificar se usu√°rio est√° logado
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            
            if (!usuario) {
                alert('‚ö†Ô∏è Voc√™ precisa fazer login antes de comprar!');
                // Salvar livro atual para redirecionar depois do login
                sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
                window.location.href = '/login';
                return;
            }
            
            const email = document.getElementById('emailInput').value;
            const livroId = {{ livro['id'] }};
            
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, livro_id: livroId, usuario_id: usuario.id })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    pedidoAtual = data.pedido_id;
                    document.getElementById('qrImage').src = 'data:image/png;base64,' + data.qr_base64;
                    document.getElementById('pixText').textContent = data.pix_text;
                    document.getElementById('qrContainer').style.display = 'block';
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao processar compra: ' + error.message);
            }
        });

        async function simularPagamento() {
            if (!pedidoAtual) {
                alert('Nenhum pedido em andamento!');
                return;
            }
            
            // Mostrar alert de sucesso do pagamento
            alert('‚úÖ Pagamento realizado com sucesso!');
            
            // Mostrar mensagem de valida√ß√£o na tela
            const qrContainer = document.getElementById('qrContainer');
            const mensagemValidacao = document.createElement('div');
            mensagemValidacao.style.cssText = 'margin-top: 20px; padding: 15px; background: #4CAF50; color: white; border-radius: 8px; font-weight: bold;';
            mensagemValidacao.innerHTML = 'üîÑ Validando pagamento e enviando e-book...';
            qrContainer.appendChild(mensagemValidacao);
            
            try {
                const response = await fetch('/api/confirmar_pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pedido_id: pedidoAtual })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar mensagem de sucesso
                    mensagemValidacao.innerHTML = '‚úÖ Pagamento validado! E-book enviado para seu e-mail com sucesso!';
                    
                    // Redirecionar ap√≥s 3 segundos
                    setTimeout(() => {
                        window.location.href = '{{ url_for("index") }}';
                    }, 3000);
                } else {
                    mensagemValidacao.style.background = '#f44336';
                    mensagemValidacao.innerHTML = '‚ùå Erro: ' + data.error;
                }
            } catch (error) {
                mensagemValidacao.style.background = '#f44336';
                mensagemValidacao.innerHTML = '‚ùå Erro ao confirmar pagamento: ' + error.message;
            }
        }
    </script>
</body>

</html>
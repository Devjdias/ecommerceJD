<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/livro.css') }}" />
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/iconLivro.png') }}" />
    <title>{{ livro['titulo'] }} - ClicLeitura</title>
</head>

<body>
    <div class="livro-detalhes">
        <a href="{{ url_for('index') }}" class="btn-voltar">‚Üê Voltar para a loja</a>
        
        <div class="livro-content">
            <div class="livro-imagem">
                {% if livro['imagem'].startswith('http') %}
                    <img src="{{ livro['imagem'] }}" alt="{{ livro['titulo'] }}" />
                {% else %}
                    <img src="{{ url_for('static', filename='images/' + livro['imagem']) }}" alt="{{ livro['titulo'] }}" />
                {% endif %}
            </div>
            
            <div class="livro-info">
                <h1>{{ livro['titulo'] }}</h1>
                <p><strong>Autor:</strong> {{ livro['autor'] }}</p>
                <p><strong>Fonte:</strong> {{ livro['origem'] }}</p>
                
                {% if livro['descricao'] %}
                <div class="descricao-box">
                    <h3>üìñ Sobre este E-book</h3>
                    <p>{{ livro['descricao'] }}</p>
                </div>
                {% endif %}
                
                <div class="preco-box">
                    <h2>R$ {{ "%.2f"|format(livro['preco']) }}</h2>
                </div>
                
                <div class="acoes-livro">
                    <button class="btn-secundario" onclick="adicionarAoCarrinho()">
                        üõí Adicionar ao Carrinho
                    </button>
                    <button class="btn-primario" onclick="abrirModalCheckout()">
                        üí≥ Comprar Agora
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE CHECKOUT -->
    <div class="modal-overlay" id="modalCheckout" onclick="fecharModalSeForaConteudo(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üí≥ Finalizar Compra</h3>
                <button class="btn-fechar" onclick="fecharModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div class="info-compra">
                    <p><strong>üìö E-book:</strong> {{ livro['titulo'] }}</p>
                    <p><strong>üí∞ Valor:</strong> R$ {{ "%.2f"|format(livro['preco']) }}</p>
                    <p style="margin-top: 15px; font-size: 0.9rem;">
                        ‚úâÔ∏è Ap√≥s o pagamento, o e-book ser√° enviado automaticamente para seu e-mail!
                    </p>
                </div>
                
                <form id="checkoutForm" class="checkout-form">
                    <input type="email" id="emailInput" placeholder="Seu melhor e-mail" required />
                    <button type="submit">üîí Gerar PIX e Comprar</button>
                </form>
                
                <div class="qr-container" id="qrContainer">
                    <h3>üì± Escaneie o QR Code PIX</h3>
                    <img id="qrImage" src="" alt="QR Code PIX" />
                    <p id="pixText"></p>
                    <button class="btn-simular" onclick="simularPagamento()">
                        ‚úÖ Simular Pagamento Realizado
                    </button>
                    <div id="mensagemStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let pedidoAtual = null;
        let usuarioLogado = null;

        // Verificar se usu√°rio est√° logado ao carregar p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            usuarioLogado = usuario;
            const emailInput = document.getElementById('emailInput');
            
            if (usuario) {
                emailInput.value = usuario.email;
                emailInput.readOnly = true;
            }
        });

        function abrirModalCheckout() {
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            
            if (!usuario) {
                alert('‚ö†Ô∏è Voc√™ precisa fazer login antes de comprar!');
                sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
                window.location.href = '/login';
                return;
            }
            
            document.getElementById('modalCheckout').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function fecharModal() {
            document.getElementById('modalCheckout').classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Resetar formul√°rio
            document.getElementById('qrContainer').classList.remove('active');
            document.getElementById('mensagemStatus').innerHTML = '';
        }

        function fecharModalSeForaConteudo(event) {
            if (event.target === event.currentTarget) {
                fecharModal();
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                fecharModal();
            }
        });

        async function adicionarAoCarrinho() {
            if (!usuarioLogado) {
                alert('‚ö†Ô∏è Voc√™ precisa fazer login para adicionar ao carrinho!');
                sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
                window.location.href = '/login';
                return;
            }

            const livroId = {{ livro['id'] }};

            try {
                const response = await fetch('/api/carrinho/adicionar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        usuario_id: usuarioLogado.id,
                        livro_id: livroId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (confirm('‚úÖ Livro adicionado ao carrinho! Deseja ir para o carrinho?')) {
                        window.location.href = '/';
                    }
                } else {
                    alert(data.error || 'Erro ao adicionar ao carrinho');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            
            if (!usuario) {
                alert('‚ö†Ô∏è Voc√™ precisa fazer login antes de comprar!');
                sessionStorage.setItem('redirectAfterLogin', window.location.pathname);
                window.location.href = '/login';
                return;
            }
            
            const email = document.getElementById('emailInput').value;
            const livroId = {{ livro['id'] }};
            
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, livro_id: livroId, usuario_id: usuario.id })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    pedidoAtual = data.pedido_id;
                    document.getElementById('qrImage').src = 'data:image/png;base64,' + data.qr_base64;
                    document.getElementById('pixText').textContent = data.pix_text;
                    document.getElementById('qrContainer').classList.add('active');
                } else {
                    alert('Erro: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao processar compra: ' + error.message);
            }
        });

        async function simularPagamento() {
            if (!pedidoAtual) {
                alert('Nenhum pedido em andamento!');
                return;
            }
            
            const statusDiv = document.getElementById('mensagemStatus');
            statusDiv.className = 'mensagem-sucesso';
            statusDiv.innerHTML = 'üîÑ Validando pagamento e enviando e-book...';
            
            try {
                const response = await fetch('/api/confirmar_pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pedido_id: pedidoAtual })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '‚úÖ Pagamento confirmado! E-book enviado para seu e-mail!';
                    
                    setTimeout(() => {
                        fecharModal();
                        window.location.href = '{{ url_for("index") }}';
                    }, 3000);
                } else {
                    statusDiv.className = 'mensagem-erro';
                    statusDiv.innerHTML = '‚ùå Erro: ' + data.error;
                }
            } catch (error) {
                statusDiv.className = 'mensagem-erro';
                statusDiv.innerHTML = '‚ùå Erro ao confirmar pagamento: ' + error.message;
            }
        }
    </script>
</body>
</html>